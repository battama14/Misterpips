<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Misterpips Mobile</title>
    <link rel="stylesheet" href="mobile-optimized.css?v=2025">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00d4ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Misterpips">
    <link rel="apple-touch-icon" href="Misterpips.jpg">

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getDatabase, ref, set, get, onValue, push } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDSDK0NfVSs_VQb3TnrixiJbOpTsmoUMvU",
            authDomain: "misterpips-b71fb.firebaseapp.com",
            databaseURL: "https://misterpips-b71fb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "misterpips-b71fb",
            storageBucket: "misterpips-b71fb.firebasestorage.app",
            messagingSenderId: "574231126409",
            appId: "1:574231126409:web:b7ed93ac4ea62e247dc158"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        window.firebaseDB = db;
        window.firebaseAuth = auth;
        window.dbRef = ref;
        window.dbGet = get;
        window.dbSet = set;
        window.onValue = onValue;
        window.push = push;
        
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                sessionStorage.setItem('firebaseUID', user.uid);
                sessionStorage.setItem('userEmail', user.email);
                console.log('🔥 Mobile Firebase prêt:', user.email);
            }
        });
    </script>
</head>
<body>
    <!-- Header Mobile -->
    <header class="mobile-header">
        <div class="header-top">
            <h1>📱 Misterpips</h1>
            <button id="menuToggle" class="menu-btn">☰</button>
        </div>
        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-value" id="mobileCapital">$1000</span>
                <span class="stat-label">Capital</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="mobileWinRate">0%</span>
                <span class="stat-label">WinRate</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="mobilePnL">$0</span>
                <span class="stat-label">P&L</span>
            </div>
        </div>
    </header>

    <!-- Overlay Menu -->
    <div id="menuOverlay" class="menu-overlay"></div>
    
    <!-- Menu Mobile -->
    <nav id="mobileMenu" class="mobile-menu">
        <div class="menu-header">
            <h3>Menu</h3>
            <button id="closeMenu" class="close-btn">✕</button>
        </div>
        <ul class="menu-list">
            <li><a href="#dashboard" data-section="dashboard">📊 Dashboard</a></li>
            <li><a href="#trades" data-section="trades">📈 Mes Trades</a></li>
            <li><a href="#calendar" data-section="calendar">📅 Calendrier</a></li>
            <li><a href="#objectives" data-section="objectives">🎯 Objectifs</a></li>
            <li><a href="#ranking" data-section="ranking">🏆 Classement</a></li>
            <li><a href="#chat" data-section="chat">💬 Chat VIP</a></li>
            <li><a href="#settings" data-section="settings">⚙️ Paramètres</a></li>
            <li><a href="index.html">🚪 Déconnexion</a></li>
        </ul>
    </nav>

    <!-- Contenu Principal -->
    <main class="mobile-main">
        <!-- Section Dashboard -->
        <section id="dashboard" class="section active">
            <div class="section-header">
                <h2>📊 Dashboard</h2>
                <button id="newTradeBtn" class="primary-btn">+ Trade</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Trades Totaux</h4>
                    <span id="totalTrades">0</span>
                </div>
                <div class="stat-card">
                    <h4>Trades Gagnants</h4>
                    <span id="winningTrades">0</span>
                </div>
                <div class="stat-card">
                    <h4>Trades Perdants</h4>
                    <span id="losingTrades">0</span>
                </div>
                <div class="stat-card">
                    <h4>Profit Total</h4>
                    <span id="totalProfit">$0</span>
                </div>
            </div>
            
            <!-- Graphiques Mobile -->
            <div class="charts-container">
                <div class="chart-card">
                    <h4>Performance</h4>
                    <canvas id="mobilePerformanceChart" width="300" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h4>Taux de Réussite</h4>
                    <canvas id="mobileWinRateChart" width="200" height="200"></canvas>
                </div>
            </div>
        </section>

        <!-- Section Trades -->
        <section id="trades" class="section">
            <div class="section-header">
                <h2>📈 Mes Trades</h2>
                <button id="addTradeBtn" class="primary-btn">+ Ajouter</button>
            </div>
            
            <div class="trades-list" id="mobileTradesList">
                <div class="no-trades">Aucun trade pour le moment</div>
            </div>
        </section>

        <!-- Section Calendrier -->
        <section id="calendar" class="section">
            <div class="section-header">
                <h2>📅 Calendrier</h2>
            </div>
            <div class="mobile-calendar" id="mobileCalendar">Calendrier</div>
        </section>

        <!-- Section Objectifs -->
        <section id="objectives" class="section">
            <div class="section-header">
                <h2>🎯 Objectifs</h2>
            </div>
            <div class="objectives-list">
                <div class="objective-card">
                    <div class="objective-header">
                        <span class="objective-icon">☀️</span>
                        <span class="objective-title">Journalier</span>
                        <span class="objective-target" id="mobileDailyTarget">$10</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="mobileDailyProgress"></div>
                    </div>
                    <span class="progress-text" id="mobileDailyPercent">0%</span>
                </div>
            </div>
        </section>

        <!-- Section Classement -->
        <section id="ranking" class="section">
            <div class="section-header">
                <h2>🏆 Classement VIP</h2>
            </div>
            <div class="ranking-list" id="mobileRankingList">
                <div class="no-ranking">Chargement du classement...</div>
            </div>
        </section>

        <!-- Section Chat VIP -->
        <section id="chat" class="section">
            <div class="section-header">
                <h2>💬 Chat VIP</h2>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Tapez votre message..." onkeypress="if(event.key==='Enter'){event.preventDefault();sendMobileMessage();}">
                    <button id="sendBtn" onclick="sendMobileMessage()" ontouchend="sendMobileMessage()">📤</button>
                </div>
            </div>
        </section>

        <!-- Section Paramètres -->
        <section id="settings" class="section">
            <div class="section-header">
                <h2>⚙️ Paramètres</h2>
            </div>
            <div class="settings-list">
                <div class="setting-item">
                    <label>Capital initial ($)</label>
                    <input type="number" id="mobileCapitalInput" value="1000">
                </div>
                <div class="setting-item">
                    <label>Pseudo</label>
                    <input type="text" id="mobileNickname" placeholder="Votre pseudo">
                </div>
                <button id="saveSettingsBtn" class="primary-btn">💾 Sauvegarder</button>
            </div>
        </section>
    </main>

    <!-- Navigation Bottom -->
    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="showMobileSection('dashboard')">
            <span class="nav-icon">📊</span>
            <span class="nav-label">Dashboard</span>
        </button>
        <button class="nav-btn" onclick="showMobileSection('trades')">
            <span class="nav-icon">📈</span>
            <span class="nav-label">Trades</span>
        </button>
        <button class="nav-btn" onclick="showMobileSection('calendar')">
            <span class="nav-icon">📅</span>
            <span class="nav-label">Calendrier</span>
        </button>
        <button class="nav-btn" onclick="showMobileSection('ranking')">
            <span class="nav-icon">🏆</span>
            <span class="nav-label">Classement</span>
        </button>
        <button class="nav-btn" onclick="showMobileSection('chat')">
            <span class="nav-icon">💬</span>
            <span class="nav-label">Chat</span>
        </button>
    </nav>

    <!-- Widget Chat Flottant -->
    <div class="chat-widget">
        <button class="chat-toggle" id="chatToggle">💬</button>
        <div id="chatBox" class="chat-box">
            <div class="chat-header">
                <span>💬 Chat VIP</span>
                <button id="chatClose" class="chat-close">✕</button>
            </div>
            <div class="chat-messages" id="widgetMessages"></div>
            <div class="chat-input">
                <input type="text" id="widgetInput" placeholder="Message...">
                <button id="widgetSend">📤</button>
            </div>
        </div>
    </div>

    <!-- Modal Trade -->
    <div id="tradeModal" class="modal">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="mobile-trades.js"></script>
    <script>
        // Variables globales
        let currentUser = null;
        let mobilePerformanceChart = null;
        let mobileWinRateChart = null;
        
        // Initialiser les graphiques mobiles
        function initMobileCharts() {
            const perfCtx = document.getElementById('mobilePerformanceChart');
            const winCtx = document.getElementById('mobileWinRateChart');
            
            if (perfCtx) {
                mobilePerformanceChart = new Chart(perfCtx, {
                    type: 'line',
                    data: {
                        labels: ['T1', 'T2', 'T3', 'T4', 'T5'],
                        datasets: [{
                            label: 'P&L',
                            data: [0, 0, 0, 0, 0],
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }
            
            if (winCtx) {
                mobileWinRateChart = new Chart(winCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Gagnants', 'Perdants'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: ['#28a745', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        // Mettre à jour les graphiques
        function updateMobileCharts() {
            if (!window.mobileTradesData) return;
            
            const trades = window.mobileTradesData;
            const closedTrades = trades.filter(t => t.status === 'closed');
            const winTrades = closedTrades.filter(t => t.pnl > 0);
            const lossTrades = closedTrades.filter(t => t.pnl <= 0);
            
            // Performance chart
            if (mobilePerformanceChart && closedTrades.length > 0) {
                const pnlData = [];
                let cumulative = 0;
                closedTrades.forEach(trade => {
                    cumulative += trade.pnl || 0;
                    pnlData.push(cumulative);
                });
                
                mobilePerformanceChart.data.labels = closedTrades.map((_, i) => `T${i+1}`);
                mobilePerformanceChart.data.datasets[0].data = pnlData;
                mobilePerformanceChart.update();
            }
            
            // WinRate chart
            if (mobileWinRateChart && closedTrades.length > 0) {
                mobileWinRateChart.data.datasets[0].data = [winTrades.length, lossTrades.length];
                mobileWinRateChart.update();
            }
        }
        
        // Navigation mobile
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('menuToggle');
            const mobileMenu = document.getElementById('mobileMenu');
            const menuOverlay = document.getElementById('menuOverlay');
            const closeMenu = document.getElementById('closeMenu');
            const menuLinks = document.querySelectorAll('.menu-list a[data-section]');
            const navBtns = document.querySelectorAll('.nav-btn[data-section]');
            
            // Menu hamburger
            menuToggle.addEventListener('click', () => {
                mobileMenu.classList.add('active');
                menuOverlay.classList.add('active');
            });
            
            function closeMenuFunc() {
                mobileMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
            }
            
            closeMenu.addEventListener('click', closeMenuFunc);
            menuOverlay.addEventListener('click', closeMenuFunc);
            
            // Navigation sections
            function showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
                
                // Mettre à jour navigation bottom
                navBtns.forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
                
                closeMenuFunc();
            }
            
            // Événements navigation
            menuLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(link.getAttribute('data-section'));
                });
            });
            
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    showSection(btn.getAttribute('data-section'));
                });
            });
            
            // Chat widget
            const chatToggle = document.getElementById('chatToggle');
            const chatBox = document.getElementById('chatBox');
            const chatClose = document.getElementById('chatClose');
            
            chatToggle.addEventListener('click', () => {
                chatBox.classList.toggle('active');
            });
            
            chatClose.addEventListener('click', () => {
                chatBox.classList.remove('active');
            });
            
            // Chat VIP
            const sendBtn = document.getElementById('sendBtn');
            const chatInput = document.getElementById('chatInput');
            
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                const uid = sessionStorage.getItem('firebaseUID');
                const email = sessionStorage.getItem('userEmail');
                
                if (window.firebaseDB && window.push && window.dbRef) {
                    const chatRef = window.dbRef(window.firebaseDB, 'vip_chat');
                    window.push(chatRef, {
                        id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        userId: uid,
                        nickname: email?.split('@')[0] || 'Mobile User',
                        message: message,
                        timestamp: Date.now(),
                        type: 'text'
                    });
                    console.log('✅ Message envoyé via widget');
                }
                
                chatInput.value = '';
            }
            
            if (sendBtn) sendBtn.addEventListener('click', sendMessage);
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendMessage();
                });
            }
            
            // Initialiser les graphiques
            setTimeout(initMobileCharts, 1000);
            
            // Exposer la fonction de mise à jour
            window.updateMobileCharts = updateMobileCharts;
            
            // Charger chat avec la bonne référence
            function loadChat() {
                if (!window.firebaseDB || !window.onValue || !window.dbRef) return;
                
                const chatRef = window.dbRef(window.firebaseDB, 'vip_chat');
                window.onValue(chatRef, (snapshot) => {
                    const messages = snapshot.val();
                    const container = document.getElementById('chatMessages');
                    
                    if (!container) return;
                    container.innerHTML = '';
                    
                    if (messages) {
                        Object.values(messages)
                            .sort((a, b) => a.timestamp - b.timestamp)
                            .forEach(msg => {
                                const div = document.createElement('div');
                                div.className = 'message received';
                                div.innerHTML = `
                                    <div class="message-content">
                                        <div class="message-text">${msg.message || msg.text}</div>
                                        <div class="message-info">
                                            <span class="message-sender">${msg.nickname || msg.sender}</span>
                                            <span class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                                        </div>
                                    </div>
                                `;
                                container.appendChild(div);
                            });
                        container.scrollTop = container.scrollHeight;
                        console.log('✅ Chat chargé:', Object.keys(messages).length, 'messages');
                    } else {
                        container.innerHTML = '<div class="no-messages">💬 Aucun message</div>';
                    }
                });
            }
            
            // Initialiser après Firebase
            setTimeout(() => {
                loadChat();
                if (window.loadMobileData) window.loadMobileData();
                if (window.loadMobileRanking) window.loadMobileRanking();
            }, 3000);
        });
        
        // Chat mobile fixé
        async function sendMobileMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            const uid = sessionStorage.getItem('firebaseUID');
            let nickname = 'Mobile User';
            
            try {
                const nicknameRef = window.dbRef(window.firebaseDB, `users/${uid}/nickname`);
                const snapshot = await window.dbGet(nicknameRef);
                if (snapshot.exists()) nickname = snapshot.val();
            } catch (error) {}
            
            const messageData = {
                id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                userId: uid,
                nickname: nickname,
                message: message,
                timestamp: Date.now(),
                type: 'text'
            };
            
            try {
                const messagesRef = window.dbRef(window.firebaseDB, 'vip_chat');
                await window.push(messagesRef, messageData);
            } catch (error) {}
            
            input.value = '';
        }
        
        // Afficher message mobile
        function addMobileMessageToUI(messageData, isOwn) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'sent' : 'received'}`;
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${messageData.message}</div>
                    <div class="message-info">
                        <span class="message-sender">${messageData.nickname}</span>
                        <span class="message-time">${new Date(messageData.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Écouter les messages - Même config que PC
        function loadMobileChat() {
            if (!window.firebaseDB || !window.onValue || !window.dbRef) return;
            
            const messagesRef = window.dbRef(window.firebaseDB, 'vip_chat'); // Même que PC
            window.onValue(messagesRef, (snapshot) => {
                const container = document.getElementById('chatMessages');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (snapshot.exists()) {
                    const messages = Object.values(snapshot.val())
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .slice(-50); // Derniers 50 messages
                    
                    messages.forEach(msg => {
                        addMobileMessageToUI(msg, msg.userId === sessionStorage.getItem('firebaseUID'));
                    });
                    
                    console.log('📱 Messages chargés:', messages.length);
                } else {
                    container.innerHTML = '<div class="no-messages">💬 Aucun message<br><small>Soyez le premier à écrire !</small></div>';
                }
            });
        }
        
        function updateMobileCalendar() {
            const calendar = document.getElementById('mobileCalendar');
            if (!calendar) return;
            
            const today = new Date();
            const month = today.getMonth();
            const year = today.getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = '<div class="calendar-grid">';
            
            // Jours de la semaine
            ['D', 'L', 'M', 'M', 'J', 'V', 'S'].forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Jours du mois
            for (let day = 1; day <= daysInMonth; day++) {
                html += `<div class="calendar-day"><div class="calendar-date">${day}</div></div>`;
            }
            
            html += '</div>';
            calendar.innerHTML = html;
        }
        
        async function saveMobileNickname() {
            const nickname = document.getElementById('mobileNickname')?.value;
            if (!nickname) {
                alert('Veuillez entrer un pseudo');
                return;
            }
            
            const uid = sessionStorage.getItem('firebaseUID');
            if (!uid || !window.firebaseDB) return;
            
            try {
                // Sauvegarder le pseudo EXACTEMENT comme PC
                const nicknameRef = window.dbRef(window.firebaseDB, `users/${uid}/nickname`);
                await window.dbSet(nicknameRef, nickname);
                
                // Mettre à jour aussi dans users/{uid} directement
                const userRef = window.dbRef(window.firebaseDB, `users/${uid}`);
                const userSnapshot = await window.dbGet(userRef);
                
                if (userSnapshot.exists()) {
                    const userData = userSnapshot.val();
                    userData.nickname = nickname;
                    userData.displayName = nickname;
                    await window.dbSet(userRef, userData);
                }
                
                alert('✅ Pseudo sauvegardé !');
                
                // Recharger le classement pour voir le changement
                if (window.loadMobileRanking) {
                    setTimeout(() => window.loadMobileRanking(), 1000);
                }
            } catch (error) {
                console.error('Erreur sauvegarde pseudo:', error);
                alert('❌ Erreur sauvegarde');
            }
        }
        
        // Menu mobile
        function openMobileMenu() {
            document.getElementById('mobileMenu').classList.add('active');
            document.getElementById('menuOverlay').classList.add('active');
        }
        
        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.remove('active');
            document.getElementById('menuOverlay').classList.remove('active');
        }
        
        function showMobileSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if (event && event.target) {
                const btn = event.target.closest('.nav-btn');
                if (btn) btn.classList.add('active');
            }
            closeMobileMenu();
        }
        
        function toggleChat() {
            document.getElementById('chatBox').classList.toggle('active');
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            updateMobileCalendar();
            
            // Événements chat multiples pour garantir le fonctionnement
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            
            if (chatInput) {
                // Événement Enter
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendMobileMessage();
                    }
                });
                
                // Événement keydown (backup)
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMobileMessage();
                    }
                });
            }
            
            if (sendBtn) {
                // Événement click
                sendBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    sendMobileMessage();
                });
                
                // Événement touch (mobile)
                sendBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    sendMobileMessage();
                });
            }
            
            // Bouton sauvegarder
            const saveBtn = document.getElementById('saveSettingsBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveMobileNickname);
            }
            
            // Initialiser le chat mobile après Firebase
            setTimeout(() => {
                loadMobileChat();
            }, 3000);
        });
    </script>
</body>
</html>