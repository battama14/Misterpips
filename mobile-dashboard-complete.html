<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Misterpips Mobile</title>
    <link rel="stylesheet" href="mobile-clean.css">
    <link rel="stylesheet" href="mobile-complete.css">
    <link rel="stylesheet" href="mobile-chat-fix.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00d4ff">

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getDatabase } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDSDK0NfVSs_VQb3TnrixiJbOpTsmoUMvU",
            authDomain: "misterpips-b71fb.firebaseapp.com",
            databaseURL: "https://misterpips-b71fb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "misterpips-b71fb",
            storageBucket: "misterpips-b71fb.firebasestorage.app",
            messagingSenderId: "574231126409",
            appId: "1:574231126409:web:b7ed93ac4ea62e247dc158"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        window.firebaseDB = db;
        window.firebaseAuth = auth;
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('âœ… Utilisateur authentifiÃ©:', user.email, 'UID:', user.uid);
                sessionStorage.setItem('firebaseUID', user.uid);
                sessionStorage.setItem('userEmail', user.email);
                window.currentUser = user.uid;
            } else {
                console.log('âŒ Pas d'utilisateur, redirection...');
                window.location.href = 'index.html';
            }
        });
    </script>
</head>
<body>
    <!-- Header Mobile -->
    <header class="mobile-header">
        <div class="header-top">
            <h1>ğŸ“± Misterpips</h1>
            <button id="menuToggle" class="menu-btn">â˜°</button>
        </div>
        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-value" id="mobileCapital">$1000</span>
                <span class="stat-label">Capital</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="mobileWinRate">0%</span>
                <span class="stat-label">WinRate</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="mobilePnL">$0</span>
                <span class="stat-label">P&L</span>
            </div>
        </div>
    </header>

    <!-- Menu Mobile -->
    <nav id="mobileMenu" class="mobile-menu">
        <div class="menu-header">
            <h3>Menu</h3>
            <button id="closeMenu" class="close-btn">âœ•</button>
        </div>
        <ul class="menu-list">
            <li><a href="#dashboard" onclick="showSection('dashboard')" ontouchend="showSection('dashboard')">ğŸ“Š Dashboard</a></li>
            <li><a href="#trades" onclick="showSection('trades')" ontouchend="showSection('trades')">ğŸ“ˆ Mes Trades</a></li>
            <li><a href="#calendar" onclick="showSection('calendar')" ontouchend="showSection('calendar')">ğŸ“… Calendrier</a></li>
            <li><a href="#objectives" onclick="showSection('objectives')" ontouchend="showSection('objectives')">ğŸ¯ Objectifs</a></li>
            <li><a href="#ranking" onclick="showSection('ranking')" ontouchend="showSection('ranking')">ğŸ† Classement</a></li>
            <li><a href="#settings" onclick="showSection('settings')" ontouchend="showSection('settings')">âš™ï¸ ParamÃ¨tres</a></li>
            <li><a href="index.html">ğŸšª DÃ©connexion</a></li>
        </ul>
    </nav>

    <!-- Contenu Principal -->
    <main class="mobile-main">
        <!-- Section Dashboard -->
        <section id="dashboard" class="section active">
            <div class="section-header">
                <h2>ğŸ“Š Dashboard</h2>
                <button id="newTradeBtn" class="primary-btn">+ Trade</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Trades Totaux</h4>
                    <span id="totalTrades">0</span>
                </div>
                <div class="stat-card">
                    <h4>Trades Gagnants</h4>
                    <span id="winningTrades">0</span>
                </div>
                <div class="stat-card">
                    <h4>Trades Perdants</h4>
                    <span id="losingTrades">0</span>
                </div>
                <div class="stat-card">
                    <h4>Ratio R/R</h4>
                    <span id="riskReward">1:1</span>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>ğŸ“ˆ Performance</h3>
                <div class="chart-placeholder" id="performanceChart">
                    <div class="chart-info">
                        <div class="chart-value" id="chartCapital">$1000</div>
                        <div class="chart-pnl" id="chartLastPnL" style="font-size: 16px; margin-top: 5px; font-weight: bold;"></div>
                        <div class="chart-label">Capital Actuel</div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>ğŸ¯ WinRate</h3>
                <div class="chart-placeholder" id="winrateChart">
                    <div class="winrate-display">
                        <div class="winrate-circle">
                            <div class="winrate-value" id="chartWinRate">0%</div>
                        </div>
                        <div class="winrate-stats">
                            <div class="win-stat positive" id="chartWins">0 Gains</div>
                            <div class="loss-stat negative" id="chartLosses">0 Pertes</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section Trades -->
        <section id="trades" class="section">
            <div class="section-header">
                <h2>ğŸ“ˆ Mes Trades</h2>
                <button id="addTradeBtn" class="primary-btn">+ Ajouter</button>
            </div>
            
            <div class="trades-list" id="mobileTradesList">
                <!-- Trades gÃ©nÃ©rÃ©s dynamiquement -->
            </div>
        </section>

        <!-- Section Calendrier -->
        <section id="calendar" class="section">
            <div class="section-header">
                <h2>ğŸ“… Calendrier</h2>
                <div class="calendar-nav">
                    <button id="prevMonthMobile">â—€</button>
                    <span id="monthYearMobile">Mois</span>
                    <button id="nextMonthMobile">â–¶</button>
                </div>
            </div>
            
            <div class="mobile-calendar" id="mobileCalendar">
                <!-- Calendrier gÃ©nÃ©rÃ© dynamiquement -->
            </div>
        </section>

        <!-- Section Objectifs -->
        <section id="objectives" class="section">
            <div class="section-header">
                <h2>ğŸ¯ Objectifs</h2>
            </div>
            
            <div class="objectives-list">
                <div class="objective-card">
                    <div class="objective-header">
                        <span class="objective-icon">â˜€ï¸</span>
                        <span class="objective-title">Journalier</span>
                        <span class="objective-target" id="mobileDailyTarget">$10</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="mobileDailyProgress"></div>
                    </div>
                    <span class="progress-text" id="mobileDailyPercent">0%</span>
                </div>
                
                <div class="objective-card">
                    <div class="objective-header">
                        <span class="objective-icon">ğŸ“…</span>
                        <span class="objective-title">Hebdomadaire</span>
                        <span class="objective-target" id="mobileWeeklyTarget">$30</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="mobileWeeklyProgress"></div>
                    </div>
                    <span class="progress-text" id="mobileWeeklyPercent">0%</span>
                </div>
                
                <div class="objective-card">
                    <div class="objective-header">
                        <span class="objective-icon">ğŸ“Š</span>
                        <span class="objective-title">Mensuel</span>
                        <span class="objective-target" id="mobileMonthlyTarget">$150</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="mobileMonthlyProgress"></div>
                    </div>
                    <span class="progress-text" id="mobileMonthlyPercent">0%</span>
                </div>
            </div>
        </section>

        <!-- Section Classement -->
        <section id="ranking" class="section">
            <div class="section-header">
                <h2>ğŸ† Classement VIP</h2>
            </div>
            
            <div class="ranking-list" id="mobileRankingList">
                <!-- Classement gÃ©nÃ©rÃ© dynamiquement -->
            </div>
        </section>

        <!-- Section ParamÃ¨tres -->
        <section id="settings" class="section">
            <div class="section-header">
                <h2>âš™ï¸ ParamÃ¨tres</h2>
            </div>
            
            <div class="settings-list">
                <div class="setting-item">
                    <label>Capital initial ($)</label>
                    <input type="number" id="mobileCapitalInput" value="1000" min="100" step="10">
                </div>
                
                <div class="setting-item">
                    <label>Objectif journalier ($)</label>
                    <input type="number" id="mobileDailyGoal" value="10" min="1" step="1">
                </div>
                
                <button class="primary-btn" id="saveSettingsBtn">ğŸ’¾ Sauvegarder</button>
            </div>
        </section>
    </main>

    <!-- Modal Trade -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“ˆ Nouveau Trade</h3>
                <button class="close-modal" id="closeTradeModal" onclick="closeMobileModal()">âœ•</button>
            </div>
            
            <form id="tradeForm" class="trade-form">
                <div class="form-group">
                    <label>Paire</label>
                    <select id="tradePair" required>
                        <option value="">SÃ©lectionner...</option>
                        <option value="EUR/USD">EUR/USD</option>
                        <option value="GBP/USD">GBP/USD</option>
                        <option value="USD/JPY">USD/JPY</option>
                        <option value="AUD/USD">AUD/USD</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Type</label>
                    <select id="tradeType" required>
                        <option value="BUY">ğŸŸ¢ BUY</option>
                        <option value="SELL">ğŸ”´ SELL</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Lot Size</label>
                    <input type="number" id="tradeLot" step="0.01" min="0.01" value="0.01" required>
                </div>
                
                <div class="form-group">
                    <label>Prix d'entrÃ©e</label>
                    <input type="number" id="tradeEntry" step="0.00001" value="1.0000" required>
                </div>
                
                <div class="form-group">
                    <label>Stop Loss</label>
                    <input type="number" id="tradeStopLoss" step="0.00001" value="0.9950" required>
                </div>
                
                <div class="form-group">
                    <label>Take Profit</label>
                    <input type="number" id="tradeTakeProfit" step="0.00001" value="1.0050" required>
                </div>
                
                <div class="form-group" id="resultGroup" style="display: none;">
                    <label>RÃ©sultat ($)</label>
                    <input type="number" id="tradeResult" step="0.01">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="secondary-btn" onclick="closeMobileModal()">Annuler</button>
                    <button type="button" class="primary-btn" onclick="addMobileTrade()">ğŸ’¾ Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>



    <!-- Navigation Bottom -->
    <nav class="bottom-nav">
        <button class="nav-btn active" data-section="dashboard">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-label">Dashboard</span>
        </button>
        <button class="nav-btn" data-section="trades">
            <span class="nav-icon">ğŸ“ˆ</span>
            <span class="nav-label">Trades</span>
        </button>
        <button class="nav-btn" data-section="calendar">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-label">Calendrier</span>
        </button>
        <button class="nav-btn" data-section="ranking">
            <span class="nav-icon">ğŸ†</span>
            <span class="nav-label">Classement</span>
        </button>
    </nav>





    <!-- Chat Widget Droite -->
    <div id="mobileChat" style="position: fixed; bottom: 100px; right: 20px; z-index: 99999;">
        <div id="chatToggle" style="width: 60px; height: 60px; background: linear-gradient(135deg, #00d4ff, #0099cc); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4); color: white; font-weight: bold;" onclick="openMobileChat()">
            ğŸ’¬
        </div>
    </div>

    <div id="chatWindow" style="position: fixed; bottom: 0; right: 20px; width: 350px; height: 500px; background: rgba(26, 26, 46, 0.98); border-radius: 15px 15px 0 0; z-index: 99998; transform: translateY(100%); transition: transform 0.3s ease; display: none;">
        <div style="padding: 15px; border-bottom: 1px solid rgba(0, 212, 255, 0.3); display: flex; justify-content: space-between; align-items: center;">
            <h4 style="color: #00d4ff; margin: 0;">ğŸ’¬ Chat VIP</h4>
            <button onclick="closeMobileChat()" style="background: #ff6b6b; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">Ã—</button>
        </div>
        <div id="chatMessages" style="height: 350px; overflow-y: auto; padding: 15px;">
            <div style="background: rgba(0, 212, 255, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                <strong style="color: #00d4ff;">Bot:</strong> Bienvenue dans le chat VIP! ğŸš€
            </div>
        </div>
        <div style="padding: 15px; border-top: 1px solid rgba(0, 212, 255, 0.3); display: flex; gap: 10px;">
            <input type="text" id="chatInput" placeholder="Votre message..." style="flex: 1; padding: 10px; border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 20px; background: rgba(255, 255, 255, 0.1); color: white;" onkeypress="if(event.key==='Enter') sendChatMessage()">
            <button onclick="sendChatMessage()" style="background: #00d4ff; border: none; color: white; padding: 10px 15px; border-radius: 50%; cursor: pointer;">â¤</button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        function openMobileChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.style.display = 'block';
            setTimeout(() => {
                chatWindow.style.transform = 'translateY(0)';
            }, 10);
        }
        
        function closeMobileChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.style.transform = 'translateY(100%)';
            setTimeout(() => {
                chatWindow.style.display = 'none';
            }, 300);
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML += `
                    <div style="background: rgba(0, 212, 255, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 10px; margin-left: auto; max-width: 80%;">
                        <strong style="color: #00d4ff;">Vous:</strong> ${message}
                        <div style="font-size: 12px; color: #888; margin-top: 5px;">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                input.value = '';
            }
        }
        
        // Forcer la position Ã  droite
        document.addEventListener('DOMContentLoaded', () => {
            const mobileChat = document.getElementById('mobileChat');
            if (mobileChat) {
                mobileChat.style.position = 'fixed';
                mobileChat.style.bottom = '100px';
                mobileChat.style.right = '20px';
                mobileChat.style.left = 'auto';
                mobileChat.style.zIndex = '99999';
            }
        });
    </script>
    <script src="mobile-trades.js"></script>
    <script src="mobile-features.js"></script>
    <script>
        // Fonctions chat mobile
        function sendMobileMessage() {
            const input = document.getElementById('mobileMessageInput');
            const message = input.value.trim();
            if (message) {
                const messagesContainer = document.getElementById('mobileMessages');
                messagesContainer.innerHTML += `
                    <div class="message-item">
                        <div class="message-author">Vous</div>
                        <div class="message-text">${message}</div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                input.value = '';
                console.log('ğŸ“± Message envoyÃ©:', message);
            }
        }
        
        function toggleEmojiPanel() {
            const panel = document.getElementById('mobileEmojiPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('mobileMessageInput');
            input.value += emoji;
            toggleEmojiPanel();
        }
        
        function toggleMobileChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.style.display = chatWindow.style.display === 'none' ? 'block' : 'none';
        }
        
        function closeMobileModal() {
            document.getElementById('tradeModal').style.display = 'none';
            editingTradeIndex = -1;
            document.querySelector('#tradeModal h3').textContent = 'ğŸ“ˆ Nouveau Trade';
            // Reset form
            document.getElementById('tradeForm').reset();
            document.getElementById('tradeLot').value = '0.01';
            document.getElementById('tradeEntry').value = '1.0000';
            document.getElementById('tradeStopLoss').value = '0.9950';
            document.getElementById('tradeTakeProfit').value = '1.0050';
            document.getElementById('tradeResult').value = '';
        }
        
        // Exposer la fonction globalement
        window.closeMobileModal = closeMobileModal;
        
        // Variables globales (systÃ¨me PC)
        window.currentUser = sessionStorage.getItem('firebaseUID');
        window.mobileTradesData = [];
        let editingTradeIndex = -1;
        let mobileCharts = {};
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let settings = { capital: 1000, riskPerTrade: 2 };
        let accounts = { compte1: { name: 'Compte Principal', capital: 1000 } };
        let currentAccount = 'compte1';
        

        

        

        

        

        

        

        
        function updateMobileCharts() {
            // Pas de graphiques Chart.js - utilise les stats cards
            const totalTrades = window.mobileTradesData ? window.mobileTradesData.length : 0;
            const winTrades = window.mobileTradesData ? window.mobileTradesData.filter(t => t.pnl > 0).length : 0;
            
            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winningTrades').textContent = winTrades;
        }
        
        // SystÃ¨me de chargement PC adaptÃ©
        async function loadMobileTrades() {
            try {
                if (window.firebaseDB && window.currentUser) {
                    const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                    const userRef = ref(window.firebaseDB, `dashboards/${window.currentUser}`);
                    const snapshot = await get(userRef);
                    
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        window.mobileTradesData = data.trades || [];
                        settings = data.settings || settings;
                        accounts = data.accounts || accounts;
                        currentAccount = data.currentAccount || currentAccount;
                        console.log('âœ… DonnÃ©es chargÃ©es depuis Firebase:', window.mobileTradesData.length, 'trades');
                    } else {
                        console.log('â„¹ï¸ Aucune donnÃ©e Firebase, valeurs par dÃ©faut');
                    }
                } else {
                    console.log('âš ï¸ Firebase ou utilisateur non disponible');
                }
            } catch (error) {
                console.error('âŒ Erreur chargement Firebase:', error);
            }
            
            updateMobileTradesList();
            updateMobileStats();
            updateMobileCharts();
            updateMobileCalendar();
            loadVIPRanking();
        }
        
        // SystÃ¨me de sauvegarde PC adaptÃ©
        async function saveMobileData() {
            if (!window.firebaseDB || !window.currentUser) return;
            
            try {
                const { ref, set } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                
                const dataToSave = {
                    trades: window.mobileTradesData,
                    settings: settings,
                    accounts: accounts,
                    currentAccount: currentAccount,
                    lastUpdated: new Date().toISOString(),
                    version: Date.now()
                };
                
                // Sauvegarder dans dashboards
                const dashboardRef = ref(window.firebaseDB, `dashboards/${window.currentUser}`);
                await set(dashboardRef, dataToSave);
                
                // Sauvegarder dans users pour le classement VIP
                const userRef = ref(window.firebaseDB, `users/${window.currentUser}`);
                await set(userRef, {
                    isVIP: true,
                    plan: 'VIP',
                    email: sessionStorage.getItem('userEmail') || 'user@example.com',
                    displayName: sessionStorage.getItem('userEmail')?.split('@')[0] || 'Trader',
                    nickname: sessionStorage.getItem('userEmail')?.split('@')[0] || 'Trader',
                    accounts: {
                        compte1: {
                            trades: window.mobileTradesData,
                            capital: accounts[currentAccount]?.capital || settings.capital,
                            settings: settings
                        }
                    },
                    lastUpdated: new Date().toISOString()
                });
                
                console.log('âœ… DonnÃ©es sauvegardÃ©es dans Firebase');
            } catch (error) {
                console.error('âŒ Erreur sauvegarde Firebase:', error);
            }
        }
        
        // Fonctions simplifiÃ©es
        window.closeTradeAs = (index, type) => closeTrade(index, type);
        window.deleteMobileTrade = (index) => deleteTrade(index);
        
        async function loadVIPRanking() {
            try {
                const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                const usersRef = ref(window.firebaseDB, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const rankings = [];
                    
                    Object.entries(users).forEach(([userId, userData]) => {
                        if (userData.isVIP && userData.accounts && userData.accounts.compte1) {
                            const trades = userData.accounts.compte1.trades || [];
                            const closedTrades = Array.isArray(trades) ? trades.filter(t => t.status === 'closed') : Object.values(trades).filter(t => t.status === 'closed');
                            const totalPnL = closedTrades.reduce((sum, trade) => sum + (parseFloat(trade.pnl) || 0), 0);
                            const winTrades = closedTrades.filter(trade => (parseFloat(trade.pnl) || 0) > 0).length;
                            const winRate = closedTrades.length > 0 ? (winTrades / closedTrades.length * 100) : 0;
                            
                            rankings.push({
                                id: userId,
                                name: userData.nickname || userData.displayName || 'Trader',
                                totalPnL: totalPnL,
                                winRate: winRate,
                                totalTrades: closedTrades.length
                            });
                        }
                    });
                    
                    rankings.sort((a, b) => b.totalPnL - a.totalPnL);
                    displayRanking(rankings);
                    console.log('âœ… Classement VIP chargÃ©:', rankings.length, 'traders');
                } else {
                    displayRanking([]);
                }
            } catch (error) {
                console.error('âŒ Erreur chargement classement:', error);
                displayRanking([]);
            }
        }
        
        function displayRanking(rankings) {
            const container = document.getElementById('mobileRankingList');
            if (!container) return;
            
            if (!rankings || rankings.length === 0) {
                container.innerHTML = '<div class="no-ranking">Aucun trader VIP pour le moment</div>';
                return;
            }
            
            let html = '';
            rankings.forEach((user, index) => {
                const position = index + 1;
                const medal = position === 1 ? 'ğŸ¥‡' : position === 2 ? 'ğŸ¥ˆ' : position === 3 ? 'ğŸ¥‰' : `${position}`;
                const pnlClass = user.totalPnL >= 0 ? 'positive' : 'negative';
                
                html += `
                    <div class="ranking-item">
                        <div class="ranking-position">${medal}</div>
                        <div class="ranking-info">
                            <div class="trader-name">${user.name}</div>
                            <div class="trader-stats">${user.totalTrades} trades â€¢ ${user.winRate.toFixed(1)}% WR</div>
                        </div>
                        <div class="ranking-pnl ${pnlClass}">$${user.totalPnL.toFixed(2)}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Ã‰vÃ©nements navigation et chat
        document.addEventListener('DOMContentLoaded', () => {
            // Navigation sections
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const section = btn.getAttribute('data-section');
                if (section) {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                        document.getElementById(section)?.classList.add('active');
                        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                        document.getElementById(section)?.classList.add('active');
                        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                }
            });
            
            // Boutons trade
            document.getElementById('newTradeBtn')?.addEventListener('click', () => {
                editingTradeIndex = -1;
                document.querySelector('#tradeModal h3').textContent = 'Nouveau Trade';
                document.getElementById('tradeModal').style.display = 'block';
            });
            document.getElementById('addTradeBtn')?.addEventListener('click', () => {
                editingTradeIndex = -1;
                document.querySelector('#tradeModal h3').textContent = 'Nouveau Trade';
                document.getElementById('tradeModal').style.display = 'block';
            });
            
            // Attendre l'authentification puis charger
            const initWhenReady = () => {
                if (window.currentUser || sessionStorage.getItem('firebaseUID')) {
                    window.currentUser = window.currentUser || sessionStorage.getItem('firebaseUID');
                    loadMobileTrades();
                    console.log('ğŸš€ Dashboard initialisÃ© pour:', window.currentUser);
                } else {
                    setTimeout(initWhenReady, 100);
                }
            };
            initWhenReady();
            
            // Navigation calendrier
            document.getElementById('prevMonthMobile')?.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateMobileCalendar();
            });
            
            document.getElementById('nextMonthMobile')?.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                updateMobileCalendar();
            });
            
            // Chat events
            const chatToggle = document.getElementById('chatToggle');
            if (chatToggle) {
                chatToggle.addEventListener('click', toggleMobileChat);
                chatToggle.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    toggleMobileChat();
                });
            }
        });
        
        // Fonction navigation globale
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId)?.classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-section="${sectionId}"]`)?.classList.add('active');
        }
        
        window.showSection = showSection;
        
        // Fonction calendrier mobile
        function updateMobileCalendar() {
            const calendar = document.getElementById('mobileCalendar');
            const monthYear = document.getElementById('monthYearMobile');
            
            if (!calendar || !monthYear) return;
            
            const months = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                          'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
            
            monthYear.textContent = `${months[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let html = '';
            
            // Jours de la semaine
            const dayNames = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
            dayNames.forEach(day => {
                html += `<div class="calendar-header-day">${day}</div>`;
            });
            
            // Jours vides au dÃ©but
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Jours du mois
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayTrades = window.mobileTradesData.filter(trade => trade.date === dateStr && trade.status === 'closed');
                const dayPnL = dayTrades.reduce((sum, trade) => sum + trade.pnl, 0);
                
                let dayClass = 'calendar-day';
                if (dayTrades.length > 0) {
                    dayClass += dayPnL >= 0 ? ' profit-day' : ' loss-day';
                }
                
                html += `
                    <div class="${dayClass}">
                        <div class="calendar-date">${day}</div>
                        ${dayTrades.length > 0 ? `<div class="calendar-pnl">$${dayPnL.toFixed(0)}</div>` : ''}
                    </div>
                `;
            }
            
            calendar.innerHTML = html;
        }
    </script>
</body>
</html>